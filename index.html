<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTC交易信号分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div id="root" class="max-w-4xl mx-auto p-4"></div>

  <script>
    async function loadData() {
      // 使用CORS代理来解决跨域问题
      const corsProxy = 'https://api.allorigins.win/get?url=';
      const apiUrl = 'https://financialmodelingprep.com/api/v3/historical-price-full/BTCUSD?timeseries=900&apikey=cKlA3lVOMxMjg4hJsC0cn1YAIUu1Hk8P';
      const proxyUrl = corsProxy + encodeURIComponent(apiUrl);
      
      console.log("正在通过CORS代理加载数据:", proxyUrl);
      
      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) {
          console.error(`代理请求失败: ${response.status} - ${response.statusText}`);
          throw new Error(`代理请求失败: ${response.status}`);
        }
        
        const proxyData = await response.json();
        const data = JSON.parse(proxyData.contents);
        console.log("原始API响应数据:", data);

        const historical = data.historical || [];
        console.log("历史数据数组长度（过滤前）:", historical.length);

        const processedData = historical
          .map(item => ({
            date: new Date(item.date),
            price: parseFloat(item.close)
          }))
          .filter(item => item.price != null && !isNaN(item.price))
          .reverse(); // 确保按时间正序排列

        console.log("处理后的历史数据长度:", processedData.length);
        if (processedData.length === 0) {
            console.warn("处理后的历史数据为空，未找到有效的价格数据。");
        }
        return processedData;
      } catch (err) {
        console.error("数据加载错误:", err);
        console.log("尝试备用数据源...");
        return await loadBackupData();
      }
    }

    async function loadBackupData() {
      // 备用数据源：使用CoinGecko API（免费且支持CORS）
      console.log("使用备用数据源：CoinGecko API");
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=90&interval=daily');
        if (!response.ok) {
          throw new Error(`备用API请求失败: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("备用API响应数据:", data);
        
        const processedData = data.prices.map(([timestamp, price]) => ({
          date: new Date(timestamp),
          price: parseFloat(price)
        })).filter(item => item.price != null && !isNaN(item.price));
        
        console.log("备用数据处理完成，长度:", processedData.length);
        return processedData;
      } catch (err) {
        console.error("备用数据源也失败:", err);
        // 如果所有API都失败，返回模拟数据用于演示
        return generateMockData();
      }
    }

    function generateMockData() {
      console.log("生成模拟数据用于演示");
      const mockData = [];
      const basePrice = 65000;
      const today = new Date();
      
      for (let i = 89; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        
        // 生成模拟价格数据，包含一些趋势和波动
        const trend = Math.sin(i * 0.1) * 5000;
        const noise = (Math.random() - 0.5) * 2000;
        const price = basePrice + trend + noise;
        
        mockData.push({
          date: date,
          price: Math.max(price, 30000) // 确保价格不会太低
        });
      }
      
      return mockData;
    }

    function calculateIndicators(data) {
      console.log("开始计算指标，数据长度:", data.length);
      
      // 首先计算所有的20日均线
      const dataWithMA = data.map((row, index, arr) => {
        let BTC20MA = null;
        if (index >= 19) { // 第20个数据点开始计算（索引19）
          const prices = arr.slice(index - 19, index + 1).map(r => r.price);
          if (prices.length === 20 && prices.every(p => typeof p === 'number' && !isNaN(p))) {
            BTC20MA = prices.reduce((sum, p) => sum + p, 0) / 20;
          }
        }
        return { ...row, BTC20MA };
      });

      // 然后计算趋势（需要在所有MA计算完成后）
      const dataWithIndicators = dataWithMA.map((row, index, arr) => {
        let BTC20MAtrend = '未知';
        
        if (row.BTC20MA != null && index > 0) {
          const prevBTC20MA = arr[index - 1].BTC20MA;
          if (prevBTC20MA != null) {
            // 根据Excel公式：IF(D2>D3,"上升","下降")
            BTC20MAtrend = row.BTC20MA > prevBTC20MA ? '上升' : '下降';
          }
        }

        return { ...row, BTC20MAtrend };
      });
      
      // 详细日志
      const validMACount = dataWithIndicators.filter(r => r.BTC20MA != null).length;
      const validTrendCount = dataWithIndicators.filter(r => r.BTC20MAtrend !== '未知').length;
      
      console.log(`MA计算结果: ${validMACount}个有效MA值, ${validTrendCount}个有效趋势值`);
      console.log("最后5个数据点:", dataWithIndicators.slice(-5).map(r => ({
        date: r.date.toLocaleDateString(),
        price: r.price,
        ma: r.BTC20MA ? r.BTC20MA.toFixed(2) : null,
        trend: r.BTC20MAtrend
      })));
      
      return dataWithIndicators;
    }

    function generateSignals(data) {
      console.log("开始生成交易信号，数据长度:", data.length);
      
      // 初始化第一行的仓位为空仓
      let currentPosition = '空仓';
      
      const dataWithSignals = data.map((row, index, arr) => {
        // 初始化信号
        let signal = '';
        
        // 从第20个数据点开始生成信号（索引19，需要有20日均线数据）
        if (index >= 19 && row.BTC20MA != null && row.BTC20MAtrend !== '未知') {
          // 当前行数据
          const currentPrice = parseFloat(row.price);
          const currentMA = parseFloat(row.BTC20MA);
          const currentTrend = row.BTC20MAtrend;

          // 确保数据有效性
          if (currentPrice && currentMA && currentTrend) {
            
            // 计算阈值
            const buyThreshold = currentMA * 1.01;  // 均线上方1%
            const sellThreshold = currentMA * 0.99; // 均线下方1%
            
            // 买入条件检查（三个条件同时满足）
            const condition1_buy = currentPosition === '空仓';
            const condition2_buy = currentTrend === '上升';
            const condition3_buy = currentPrice > buyThreshold;
            
            if (condition1_buy && condition2_buy && condition3_buy) {
              signal = '买入';
              currentPosition = '持有'; // 立即更新仓位
            }
            
            // 卖出条件检查（三个条件同时满足）
            const condition1_sell = currentPosition === '持有';
            const condition2_sell = currentTrend === '下降';
            const condition3_sell = currentPrice < sellThreshold;
            
            if (condition1_sell && condition2_sell && condition3_sell) {
              signal = '卖出';
              currentPosition = '空仓'; // 立即更新仓位
            }

            // 调试输出（显示更多天数以便分析）
            if (index >= data.length - 15 || (signal && signal !== '')) {
              const priceVsMA = ((currentPrice - currentMA) / currentMA * 100);
              console.log(`=== 第${index + 1}天 (${formatDate(row.date)}) ===`);
              console.log(`价格: ${currentPrice.toFixed(2)}`);
              console.log(`均线: ${currentMA.toFixed(2)}`);
              console.log(`价格相对均线: ${priceVsMA.toFixed(2)}%`);
              console.log(`趋势: ${currentTrend}`);
              console.log(`当前仓位: ${currentPosition}`);
              console.log(`买入阈值: ${buyThreshold.toFixed(2)}`);
              console.log(`卖出阈值: ${sellThreshold.toFixed(2)}`);
              console.log(`买入条件: 空仓(${condition1_buy}) + 上升(${condition2_buy}) + 价格>${buyThreshold.toFixed(2)}(${condition3_buy}) = ${condition1_buy && condition2_buy && condition3_buy}`);
              console.log(`卖出条件: 持有(${condition1_sell}) + 下降(${condition2_sell}) + 价格<${sellThreshold.toFixed(2)}(${condition3_sell}) = ${condition1_sell && condition2_sell && condition3_sell}`);
              console.log(`信号: ${signal || '无'}`);
              console.log(`更新后仓位: ${currentPosition}`);
              console.log('---');
            }
          }
        }

        return { 
          ...row, 
          Signal: signal, 
          POSITION: currentPosition 
        };
      });
      
      // 统计信号
      const allSignals = dataWithSignals.filter(r => r.Signal && r.Signal !== '');
      const buySignals = dataWithSignals.filter(r => r.Signal === '买入');
      const sellSignals = dataWithSignals.filter(r => r.Signal === '卖出');
      
      console.log(`信号生成完成：`);
      console.log(`- 总交易信号: ${allSignals.length} 个`);
      console.log(`- 买入信号: ${buySignals.length} 个`);
      console.log(`- 卖出信号: ${sellSignals.length} 个`);
      console.log(`- 最终仓位状态: ${currentPosition}`);
      
      if (buySignals.length > 0) {
        console.log('买入信号日期:', buySignals.map(s => formatDate(s.date)));
      }
      if (sellSignals.length > 0) {
        console.log('卖出信号日期:', sellSignals.map(s => formatDate(s.date)));
      }
      
      return dataWithSignals;
    }

    function formatNumber(num) {
      if (num == null || isNaN(num)) return 'N/A';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    function formatDate(date) {
      return date.toLocaleDateString('zh-CN');
    }

    async function renderDashboard() {
      const root = document.getElementById('root');
      root.innerHTML = '<div class="text-center text-xl text-gray-600 mt-10">📊 正在加载数据...</div>';
      console.log("开始渲染仪表板。");

      const rawData = await loadData();
      if (rawData.length < 20) {
        root.innerHTML = `
          <div class="text-center text-red-600 mt-10">
            <h2 class="text-2xl font-bold mb-4">⚠️ 数据不足</h2>
            <p>无法加载足够数据进行分析。需要至少20天的数据，当前只有 ${rawData.length} 天。</p>
            <p class="mt-2">请检查API密钥、API服务状态或稍后再试。</p>
          </div>
        `;
        console.error(`数据不足进行分析: 找到${rawData.length}天数据，需要20天。`);
        return;
      }

      const dataWithMA = calculateIndicators(rawData);
      const dataWithSignals = generateSignals(dataWithMA);

      // 获取最新数据 - 修复当前交易建议显示
      const latest = dataWithSignals[dataWithSignals.length - 1] || {};
      const currentPosition = latest.POSITION || '未知';
      console.log(`获取最新数据: 最后一天是 ${formatDate(latest.date)}, 仓位: ${currentPosition}, 信号: ${latest.Signal || '无'}`);
      
      const latestPrice = latest.price || 0;
      const latestChange = dataWithSignals.length > 1 && dataWithSignals[dataWithSignals.length - 2].price !== 0
        ? ((latestPrice - dataWithSignals[dataWithSignals.length - 2].price) / dataWithSignals[dataWithSignals.length - 2].price * 100).toFixed(2)
        : 'N/A';
      const latest20MA = latest.BTC20MA;
      const latestTrend = latest.BTC20MAtrend || '未知';
      const pricePosition = (latestPrice != null && latest20MA != null && latest20MA !== 0)
        ? (latestPrice > latest20MA ? '高于20日均线' : '低于20日均线')
        : '未知';

      // 获取最近的交易信号
      const recentSignals = dataWithSignals
        .filter(r => r.Signal && r.Signal !== '')
        .slice(-5)
        .reverse();
      console.log("找到的最近交易信号:", recentSignals);

      // 计算统计信息
      const totalSignals = dataWithSignals.filter(r => r.Signal && r.Signal !== '').length;
      const buySignals = dataWithSignals.filter(r => r.Signal === '买入').length;
      const sellSignals = dataWithSignals.filter(r => r.Signal === '卖出').length;

      root.innerHTML = `
        <div class="bg-white shadow-xl rounded-lg p-8">
          <h1 class="text-3xl font-bold text-blue-600 mb-6 flex items-center">
            📊 BTC交易信号分析系统
            <span class="ml-4 text-sm text-gray-500 font-normal">实时更新</span>
          </h1>

          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">🎯 当前交易建议</h2>
              <p class="text-2xl font-bold ${currentPosition === '持有' ? 'text-green-600' : currentPosition === '空仓' ? 'text-red-600' : 'text-gray-500'}">${currentPosition}</p>
            </div>

            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">💰 当前价格</h2>
              <p class="text-2xl font-bold text-green-600">$${formatNumber(latestPrice)}</p>
              <p class="text-gray-600">24h变化: ${latestChange}%</p>
            </div>

            <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">📈 20日均线</h2>
              <p class="text-xl font-bold text-yellow-600">$${formatNumber(latest20MA)}</p>
              <p class="text-gray-600">趋势: ${latestTrend}</p>
              <p class="text-gray-600">位置: ${pricePosition}</p>
            </div>

            <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">📊 信号统计</h2>
              <p class="text-sm text-gray-600">总信号: ${totalSignals}</p>
              <p class="text-sm text-green-600">买入: ${buySignals}</p>
              <p class="text-sm text-red-600">卖出: ${sellSignals}</p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-4">🔍 最近交易信号</h2>
              <div class="space-y-2">
                ${recentSignals.length > 0 ? recentSignals.map(s => `
                  <div class="flex justify-between items-center border-b py-2">
                    <span class="text-gray-600">${formatDate(s.date)}</span>
                    <span class="px-2 py-1 rounded text-sm font-medium ${s.Signal === '买入' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${s.Signal}</span>
                    <span class="font-mono text-sm">$${formatNumber(s.price)}</span>
                  </div>
                `).join('') : '<div class="text-gray-500 text-center py-4">暂无近期交易信号</div>'}
              </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-4">📋 交易逻辑说明</h2>
              <div class="text-sm text-gray-600 space-y-3">
                <div>
                  <p><strong>买入条件（三个条件同时满足）:</strong></p>
                  <ul class="list-decimal list-inside ml-2 space-y-1">
                    <li>当前属于空仓状态</li>
                    <li>20均线趋势上升</li>
                    <li>价格高于均线1%以上</li>
                  </ul>
                </div>
                <div>
                  <p><strong>卖出条件（三个条件同时满足）:</strong></p>
                  <ul class="list-decimal list-inside ml-2 space-y-1">
                    <li>当前属于持仓状态</li>
                    <li>20均线趋势下降</li>
                    <li>价格低于均线1%以上</li>
                  </ul>
                </div>
                <div class="mt-3 p-2 bg-blue-50 rounded">
                  <p class="text-xs text-blue-700">
                    <strong>注意：</strong>买入后立即转为"持有"状态，卖出后立即转为"空仓"状态。仓位状态会持续到下一个相反信号出现。
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">📈 价格走势图</h2>
            <div class="bg-white rounded-lg">
              <canvas id="chart" height="100"></canvas>
            </div>
          </div>

          <div class="text-center">
            <p class="text-gray-500 text-xs">
              ⚠️ 本分析仅供参考，投资有风险，决策需谨慎。最后更新时间: ${new Date().toLocaleString('zh-CN')}
            </p>
            <button onclick="window.showDebugInfo()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
              显示调试信息
            </button>
            <div id="debugInfo" class="hidden mt-4 p-4 bg-gray-100 rounded text-left text-xs">
              <h3 class="font-bold mb-2">调试信息：</h3>
              <div id="debugContent"></div>
            </div>
          </div>
        </div>
      `;

      // 绘制图表
      const ctx = document.getElementById('chart').getContext('2d');
      
      // 准备图表数据 - 只显示最近60天的数据以提高性能
      const chartData = dataWithSignals.slice(-60);
      const buyPoints = chartData.filter(r => r.Signal === '买入');
      const sellPoints = chartData.filter(r => r.Signal === '卖出');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(r => formatDate(r.date)),
          datasets: [
            {
              label: 'BTC价格',
              data: chartData.map(r => r.price),
              borderColor: '#3B82F6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              tension: 0.1,
              fill: false,
              pointRadius: 1,
              pointHoverRadius: 5
            },
            {
              label: '20日均线',
              data: chartData.map(r => r.BTC20MA),
              borderColor: '#F59E0B',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 2,
              tension: 0.1,
              fill: false,
              pointRadius: 1,
              pointHoverRadius: 5
            },
            {
              label: '买入信号',
              data: chartData.map(r => r.Signal === '买入' ? r.price : null),
              borderColor: '#10B981',
              backgroundColor: '#10B981',
              pointBackgroundColor: '#10B981',
              pointBorderColor: '#ffffff',
              pointRadius: 6,
              pointHoverRadius: 8,
              showLine: false,
              tension: 0
            },
            {
              label: '卖出信号',
              data: chartData.map(r => r.Signal === '卖出' ? r.price : null),
              borderColor: '#EF4444',
              backgroundColor: '#EF4444',
              pointBackgroundColor: '#EF4444',
              pointBorderColor: '#ffffff',
              pointRadius: 6,
              pointHoverRadius: 8,
              showLine: false,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { position: 'top' },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  if (context.dataset.label.includes('信号')) {
                    return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                  }
                  return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: '日期'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: '价格 (USD)'
              },
              ticks: { 
                callback: value => '$' + formatNumber(value)
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
      
      console.log("仪表板渲染完成。");
      
      // 添加调试功能
      window.showDebugInfo = function() {
        const debugDiv = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        
        if (debugDiv.classList.contains('hidden')) {
          debugDiv.classList.remove('hidden');
          
          const lastData = dataWithSignals.slice(-10);
          let debugHTML = '<p><strong>最后10天数据分析：</strong></p>';
          
          lastData.forEach((item, idx) => {
            const actualIndex = dataWithSignals.length - 10 + idx;
            debugHTML += `
              <div class="mb-2 p-2 border rounded">
                <strong>第${actualIndex + 1}天 (${formatDate(item.date)}):</strong><br>
                价格: ${formatNumber(item.price)}<br>
                20日均线: ${item.BTC20MA ? formatNumber(item.BTC20MA) : 'N/A'}<br>
                趋势: ${item.BTC20MAtrend}<br>
                信号: ${item.Signal || '无'}<br>
                仓位: ${item.POSITION}
              </div>
            `;
          });
          
          debugHTML += `<p class="mt-4"><strong>总数据量:</strong> ${dataWithSignals.length} 天</p>`;
          debugHTML += `<p><strong>有效均线数据:</strong> ${dataWithSignals.filter(r => r.BTC20MA != null).length} 天</p>`;
          debugHTML += `<p><strong>有趋势数据:</strong> ${dataWithSignals.filter(r => r.BTC20MAtrend !== '未知').length} 天</p>`;
          debugHTML += `<p><strong>总交易信号:</strong> ${dataWithSignals.filter(r => r.Signal && r.Signal !== '').length} 个</p>`;
          
          debugContent.innerHTML = debugHTML;
        } else {
          debugDiv.classList.add('hidden');
        }
      };
    }

    // 初始化渲染
    renderDashboard();
    
    // 设置自动刷新 - 每5分钟更新一次
    setInterval(renderDashboard, 5 * 60 * 1000);
  </script>

</body>
</html>
