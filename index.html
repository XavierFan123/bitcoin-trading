```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTCäº¤æ˜“ä¿¡å·åˆ†æ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chrono-node/1.3.11/chrono.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script> <!-- Fixed version of Papa Parse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Note: For production, install Tailwind as a PostCSS plugin or CLI as per https://tailwindcss.com/docs/guides/installation -->
</head>
<body class="bg-gray-100 font-sans">
  <div id="root" class="container mx-auto p-4"></div>

  <script>
    // Fallback sample data
    function getFallbackData() {
      return `Column1.date,Column1.close
2025-07-24,118226.87
2025-07-23,118810.44
2025-07-22,120030.12
2025-06-24,106141
2025-05-07,103456
2025-04-22,108765
2025-04-21,101876
2025-04-20,102432`;
    }

    // Fetch data from Financial Modeling Prep API
    function loadFileData() {
      const apiUrl = 'https://financialmodelingprep.com/api/v3/historical-price-full/BTCUSD?timeseries=900&apikey=cKlA3lVOMxMjg4hJsC0cn1YAIUu1Hk8P';
      return fetch(apiUrl)
        .then(response => {
          if (!response.ok) throw new Error(`API request failed: ${response.status} ${response.statusText}`);
          return response.json();
        })
        .then(data => {
          const historical = data.historical || [];
          if (!historical.length) throw new Error('No historical data returned from API');
          const csvRows = ['Column1.date,Column1.close'];
          historical.forEach(row => {
            csvRows.push(`${row.date},${row.close}`);
          });
          return csvRows.join('\n');
        })
        .catch(err => {
          console.error('Error fetching API:', err);
          return getFallbackData(); // Use fallback data on error
        });
    }

    // Calculate 20-day MA and trend
    function calculateIndicators(data) {
      return data.map((row, index, arr) => {
        let BTC20MA = null;
        if (index >= 19) {
          const prices = arr.slice(index - 19, index + 1).map(r => r.price);
          BTC20MA = prices.reduce((sum, price) => sum + price, 0) / 20;
        }
        const prevBTC20MA = index > 19 ? arr[index - 1].BTC20MA : null;
        const BTC20MAtrend = BTC20MA && prevBTC20MA
          ? BTC20MA > prevBTC20MA ? 'ä¸Šå‡' : 'ä¸‹é™'
          : 'æœªçŸ¥';
        return { ...row, BTC20MA, BTC20MAtrend };
      });
    }

    // Generate trading signals based on Excel formula
    function generateSignals(data) {
      return data.map((row, index, arr) => {
        if (index === 0) {
          return { ...row, Signal: '', POSITION: 'ç©ºä»“' };
        }
        const prevRow = arr[index - 1];
        const B2 = row.price;
        const D2 = row.BTC20MA;
        const F2 = row.BTC20MAtrend;
        const B3 = prevRow.price;
        const D3 = prevRow.BTC20MA;
        const F3 = prevRow.BTC20MAtrend;
        const I3 = prevRow.POSITION;

        let signal = '';
        if (
          D2 > B2 &&
          F2 === 'ä¸‹é™' &&
          (
            (B2 < D2 * (1 - 0.01) && B3 >= D3) ||
            (I3 === 'æŒæœ‰' && B2 < D2 && F3 === 'ä¸Šå‡')
          )
        ) {
          signal = 'å–å‡º';
        }
        else if (
          D2 < B2 &&
          F2 === 'ä¸Šå‡' &&
          (
            (B2 > D2 * (1 + 0.01) && B3 <= D3) ||
            (I3 === 'ç©ºä»“' && B2 > D2 && F3 === 'ä¸‹é™')
          )
        ) {
          signal = 'ä¹°å…¥';
        }
        const position = signal === 'ä¹°å…¥' ? 'æŒæœ‰' : signal === 'å–å‡º' ? 'ç©ºä»“' : prevRow.POSITION;
        return { ...row, Signal: signal, POSITION: position };
      });
    }

    // Main component logic
    function BitcoinTradingDashboard() {
      let data = [];
      let loading = true;
      let lastUpdate = '-';
      let error = null;
      let showAllData = false;

      function setData(newData) { data = newData; render(); }
      function setLoading(newLoading) { loading = newLoading; render(); }
      function setLastUpdate(newUpdate) { lastUpdate = newUpdate; render(); }
      function setError(newError) { error = newError; render(); }
      function setShowAllData(newValue) { showAllData = newValue; render(); }

      function fetchData() {
        setLoading(true);
        setError(null);
        loadFileData().then(csv => {
          if (!csv) {
            setError('æ— æ³•åŠ è½½æ•°æ®ï¼šæ•°æ®æºè¿”å›ç©º');
            setLoading(false);
            return;
          }
          Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            transformHeader: header => header.trim().replace(/^"|"$/g, ''),
            transform: (value, header) => {
              let cleaned = value.trim().replace(/^"|"$/g, '');
              if (header === 'Column1.date') {
                return chrono.parseDate(cleaned) || null;
              }
              if (header === 'Column1.close') {
                const num = parseFloat(cleaned);
                return isNaN(num) ? null : num;
              }
              return cleaned;
            },
            complete: results => {
              const cleanedData = results.data
                .filter(row => row['Column1.date'] && row['Column1.close'])
                .map(row => ({
                  date: row['Column1.date'],
                  price: row['Column1.close'],
                }))
                .sort((a, b) => a.date - b.date);
              const dataWithMA = calculateIndicators(cleanedData);
              const dataWithSignals = generateSignals(dataWithMA);
              setData(dataWithSignals);
              setLastUpdate(new Date().toLocaleString());
              setLoading(false);
            },
            error: err => {
              console.error('Error parsing data:', err);
              setError(`æ•°æ®è§£æå¤±è´¥ï¼š${err.message}`);
              setLoading(false);
            },
          });
        });
      }

      // Initial fetch and auto-refresh every 5 minutes
      fetchData();
      setInterval(fetchData, 5 * 60 * 1000);

      // Filter data for display
      const filteredData = showAllData
        ? data
        : data.filter(row => {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            return row.date >= thirtyDaysAgo;
          });

      // Extract signals for table
      const signals = filteredData
        .filter(row => row.Signal)
        .slice(-5)
        .reverse();

      // Get current metrics
      const currentPosition = data.length > 0 ? data[data.length - 1].POSITION : 'æœªçŸ¥';
      const latestPrice = data.length > 0 ? data[data.length - 1].price : 0;
      const latestChange = data.length > 0 && data.length > 1
        ? ((data[data.length - 1].price - data[data.length - 2].price) / data[data.length - 2].price * 100).toFixed(2)
        : 0;
      const latest20MA = data.length > 0 ? data[data.length - 1].BTC20MA : 0;
      const latestTrend = data.length > 0 ? data[data.length - 1].BTC20MAtrend : 'åˆ†æä¸­...';
      const pricePosition = latestPrice && latest20MA
        ? latestPrice > latest20MA ? 'é«˜äº20æ—¥å‡çº¿' : 'ä½äº20æ—¥å‡çº¿'
        : 'åˆ†æä¸­...';

      // Format numbers
      const formatNumber = num => {
        if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
        if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
        return num.toFixed(2);
      };

      // Render function
      function render() {
        const root = document.getElementById('root');
        if (loading) {
          root.innerHTML = '<div class="text-center text-xl text-gray-600 mt-10">ğŸ“Š æ­£åœ¨è·å–æœ€æ–°BTCä»·æ ¼æ•°æ®...</div>';
          return;
        }
        if (error || !data.length) {
          root.innerHTML = `
            <div class="text-center text-xl text-red-600 mt-10">
              âš ï¸ æ— æ³•åŠ è½½æ•°æ®ï¼š${error || 'æ•°æ®æºè¿”å›ç©ºï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æˆ–ç½‘ç»œè¿æ¥'}
              <button onclick="fetchData()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ğŸ”„ é‡è¯•</button>
            </div>
          `;
          return;
        }
        root.innerHTML = `
          <div class="bg-white shadow-lg rounded-lg p-6">
            <h1 class="text-3xl font-bold text-blue-600 mb-4 flex items-center">ğŸ“Š BTCäº¤æ˜“ä¿¡å·åˆ†æ</h1>
            <p class="text-gray-600 mb-4">åŸºäºå®æ—¶ä»·æ ¼æ•°æ®å’ŒæŠ€æœ¯æŒ‡æ ‡çš„æ™ºèƒ½äº¤æ˜“å»ºè®®</p>
            <p class="text-gray-600 mb-4 italic">ç­–ç•¥ç‰¹ç‚¹ï¼šæ•æ‰é«˜æ³¢åŠ¨æ€§æœºä¼šï¼Œä½†ä¿¡å·è¾ƒä¸ºç¨€ç–ï¼Œå¯èƒ½é”™è¿‡å°å¹…æ³¢åŠ¨ã€‚</p>
            <div class="mb-4">
              <p class="text-gray-600">ğŸ“… æœ€åæ›´æ–°: ${lastUpdate}</p>
              <div class="flex space-x-2 mt-2">
                <button onclick="fetchData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ğŸ”„ ç«‹å³åˆ·æ–°</button>
                <span class="text-gray-600 self-center">ğŸ“¡ æ•°æ®æ›´æ–°é¢‘ç‡: æ¯5åˆ†é’Ÿ</span>
              </div>
            </div>
            <div class="mb-6">
              <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ¯ å½“å‰äº¤æ˜“å»ºè®®</h2>
              <p class="text-lg font-bold text-blue-800">${currentPosition}</p>
              <p class="text-gray-600">åŸºäºæœ€æ–°å¸‚åœºæ•°æ®åˆ†æ</p>
            </div>
            <div class="mb-6">
              <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ’° ä»·æ ¼ä¿¡æ¯</h2>
              <p class="text-2xl font-bold text-green-600">$$  {formatNumber(latestPrice)}</p>
              <p class="text-gray-600">å˜åŒ–: ${latestChange}%</p>
              <p class="text-gray-500 text-sm">æ•°æ®æ¥æº: Financial Modeling Prep</p>
            </div>
            <div class="mb-6">
              <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ“ˆ ç§»åŠ¨å¹³å‡çº¿å¯¹æ¯”</h2>
              <div class="flex space-x-4">
                <div>
                  <p class="text-lg font-bold text-blue-600">  $${formatNumber(latest20MA)}</p>
                  <p class="text-gray-600">20æ—¥å‡çº¿</p>
                </div>
              </div>
            </div>
            <div class="mb-6">
              <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ” æŠ€æœ¯æŒ‡æ ‡</h2>
              <p>ä»·æ ¼ä½ç½®: <span class="font-semibold">${pricePosition}</span></p>
              <p>è¶‹åŠ¿å¼ºåº¦: <span class="font-semibold">${latestTrend}</span></p>
            </div>
            <div class="mb-8">
              <div style="width: 100%; height: 400px">
                <canvas id="chart"></canvas>
              </div>
              <script>
                const chartData = {
                  labels: filteredData.map(row => row.date.toLocaleDateString()),
                  datasets: [
                    {
                      label: 'BTCä»·æ ¼',
                      data: filteredData.map(row => row.price),
                      fill: false,
                      borderColor: '#3B82F6',
                      borderWidth: 2,
                      tension: 0.1
                    },
                    {
                      label: '20æ—¥å‡çº¿',
                      data: filteredData.map(row => row.BTC20MA),
                      fill: false,
                      borderColor: '#F59E0B',
                      borderWidth: 2,
                      tension: 0.1
                    },
                    {
                      label: 'ä¹°å…¥ä¿¡å·',
                      data: filteredData.filter(row => row.Signal === 'ä¹°å…¥').map(row => ({ x: row.date.toLocaleDateString(), y: row.price })),
                      backgroundColor: '#10B981',
                      pointStyle: 'triangle'
                    },
                    {
                      label: 'å–å‡ºä¿¡å·',
                      data: filteredData.filter(row => row.Signal === 'å–å‡º').map(row => ({ x: row.date.toLocaleDateString(), y: row.price })),
                      backgroundColor: '#EF4444',
                      pointStyle: 'cross'
                    }
                  ]
                };
                new Chart(document.getElementById('chart'), {
                  type: 'line',
                  data: chartData,
                  options: {
                    responsive: true,
                    scales: {
                      x: { title: { display: true, text: 'æ—¥æœŸ' } },
                      y: { title: { display: true, text: 'BTCä»·æ ¼ (USD)' }, ticks: { callback: value => `$${formatNumber(value)}` } }
                    },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: context => `$${formatNumber(context.raw)}` } } }
                  }
                });
              </script>
            </div>
            <div class="mb-6">
              <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ“‹ è¿‘æœŸäº¤æ˜“ä¿¡å·</h2>
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead>
                    <tr class="bg-blue-100">
                      <th class="p-2">æ—¥æœŸ</th>
                      <th class="p-2">ä¿¡å·</th>
                      <th class="p-2">ä»·æ ¼ (USD)</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${signals.map((signal, index) => `
                      <tr key="${index}" class="border-b">
                        <td class="p-2">${signal.date.toLocaleDateString()}</td>
                        <td class="p-2 ${signal.Signal === 'ä¹°å…¥' ? 'text-green-600' : 'text-red-600'}">${signal.Signal}</td>
                        <td class="p-2">${formatNumber(signal.price)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            <div class="text-gray-500 text-sm">
              <p>âš ï¸ æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…</p>
              <p>ğŸ¤– åŸºäºå®æ—¶æ•°æ®çš„é‡åŒ–åˆ†æç³»ç»Ÿ</p>
            </div>
          </div>
        `;
      }

      render();
    }

    // Initialize the dashboard
    BitcoinTradingDashboard();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
