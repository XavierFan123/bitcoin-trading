<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTC交易信号分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chrono-node/1.3.11/chrono.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root" class="container mx-auto p-4"></div>

  <script>
    async function loadFileData() {
      const apiUrl = 'https://financialmodelingprep.com/api/v3/historical-price-full/BTCUSD?timeseries=900&apikey=cKlA3lVOMxMjg4hJsC0cn1YAIUu1Hk8P';
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`API请求失败: ${response.status}`);
        const data = await response.json();
        const historical = data.historical || [];
        return historical.map(item => ({
          date: new Date(item.date),
          price: item.close
        })).reverse();
      } catch (err) {
        console.error(err);
        // Fallback sample data
        return [
          {date: new Date('2025-07-24'), price: 118226.87},
          {date: new Date('2025-07-23'), price: 118810.44},
          {date: new Date('2025-07-22'), price: 120030.12},
          {date: new Date('2025-06-24'), price: 106141},
          {date: new Date('2025-05-07'), price: 103456},
        ];
      }
    }

    function calculateIndicators(data) {
      return data.map((row, index, arr) => {
        let BTC20MA = null;
        if (index >= 19) {
          const prices = arr.slice(index - 19, index + 1).map(r => r.price);
          BTC20MA = prices.reduce((sum, p) => sum + p, 0) / 20;
        }
        const prevBTC20MA = index > 19 ? arr[index - 1].BTC20MA : null;
        const BTC20MAtrend = BTC20MA && prevBTC20MA
          ? (BTC20MA > prevBTC20MA ? '上升' : '下降')
          : '未知';
        return { ...row, BTC20MA, BTC20MAtrend };
      });
    }

    function generateSignals(data) {
  return data.map((row, index, arr) => {
    if (index === 0) {
      return { ...row, Signal: '', POSITION: '空仓' };
    }
    const prevRow = arr[index - 1];

    const B2 = row.price;
    const D2 = row.BTC20MA;
    const F2 = row.BTC20MAtrend;
    const B3 = prevRow.price;
    const D3 = prevRow.BTC20MA;
    const F3 = prevRow.BTC20MAtrend;
    const I3 = prevRow.POSITION;

    let signal = '';

    if (
      D2 != null && B2 != null &&
      D2 > B2 &&
      F2 === '下降' &&
      (
        (B2 < D2 * (1 - 0.01) && B3 >= D3) ||
        (I3 === '持有' && B2 < D2 && F3 === '上升')
      )
    ) {
      signal = '卖出';
    }
    else if (
      D2 != null && B2 != null &&
      D2 < B2 &&
      F2 === '上升' &&
      (
        (B2 > D2 * (1 + 0.01) && B3 <= D3) ||
        (I3 === '空仓' && B2 > D2 && F3 === '下降')
      )
    ) {
      signal = '买入';
    }

    const position = signal === '买入' ? '持有' :
                     signal === '卖出' ? '空仓' :
                     prevRow.POSITION;

    return { ...row, Signal: signal, POSITION: position };
  });
}

    function formatNumber(num) {
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    async function renderDashboard() {
      const root = document.getElementById('root');
      root.innerHTML = '<div class="text-center text-xl text-gray-600 mt-10">📊 正在加载数据...</div>';

      const rawData = await loadFileData();
      const dataWithMA = calculateIndicators(rawData);
      const dataWithSignals = generateSignals(dataWithMA);

      const latest = dataWithSignals[dataWithSignals.length - 1] || {};
      const currentPosition = latest.POSITION || '未知';
      const latestPrice = latest.price || 0;
      const latestChange = dataWithSignals.length > 1
        ? ((latestPrice - dataWithSignals[dataWithSignals.length - 2].price) / dataWithSignals[dataWithSignals.length - 2].price * 100).toFixed(2)
        : 0;
      const latest20MA = latest.BTC20MA || 0;
      const latestTrend = latest.BTC20MAtrend || '分析中...';
      const pricePosition = latestPrice > latest20MA ? '高于20日均线' : '低于20日均线';

      const recentSignals = dataWithSignals.filter(r => r.Signal).slice(-5).reverse();

      root.innerHTML = `
        <div class="bg-white shadow-lg rounded-lg p-6">
          <h1 class="text-3xl font-bold text-blue-600 mb-4">📊 BTC交易信号分析</h1>
          <p class="text-gray-600 mb-4">基于实时价格数据和技术指标的智能交易建议</p>

          <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">🎯 当前交易建议</h2>
            <p class="text-lg font-bold text-blue-800">${currentPosition}</p>
            <p class="text-gray-600">基于最新市场数据分析</p>
          </div>

          <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">💰 价格信息</h2>
            <p class="text-2xl font-bold text-green-600">$${formatNumber(latestPrice)}</p>
            <p class="text-gray-600">变化: ${latestChange}%</p>
          </div>

          <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">📈 20日均线</h2>
            <p class="text-lg font-bold text-yellow-600">$${formatNumber(latest20MA)}</p>
            <p class="text-gray-600">趋势: ${latestTrend}</p>
            <p class="text-gray-600">位置: ${pricePosition}</p>
          </div>

          <div class="mb-8">
            <canvas id="chart" height="400"></canvas>
          </div>

          <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">📋 近期交易信号</h2>
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="bg-blue-100">
                  <th class="p-2">日期</th>
                  <th class="p-2">信号</th>
                  <th class="p-2">价格</th>
                </tr>
              </thead>
              <tbody>
                ${recentSignals.map(s => `
                  <tr class="border-b">
                    <td class="p-2">${s.date.toLocaleDateString()}</td>
                    <td class="p-2 ${s.Signal === '买入' ? 'text-green-600' : 'text-red-600'}">${s.Signal}</td>
                    <td class="p-2">$${formatNumber(s.price)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <div class="text-gray-500 text-sm">
            ⚠️ 本分析仅供参考，投资有风险，决策需谨慎
          </div>
        </div>
      `;

      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dataWithSignals.map(r => r.date.toLocaleDateString()),
          datasets: [
            {
              label: 'BTC价格',
              data: dataWithSignals.map(r => r.price),
              borderColor: '#3B82F6',
              borderWidth: 2,
              tension: 0.1,
              fill: false
            },
            {
              label: '20日均线',
              data: dataWithSignals.map(r => r.BTC20MA),
              borderColor: '#F59E0B',
              borderWidth: 2,
              tension: 0.1,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: {
            y: {
              ticks: { callback: value => '$' + formatNumber(value) }
            }
          }
        }
      });
    }

    renderDashboard();
    setInterval(renderDashboard, 5 * 60 * 1000); // auto-refresh every 5 minutes
  </script>
</body>
</html>
