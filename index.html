<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTCäº¤æ˜“ä¿¡å·åˆ†æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div id="root" class="max-w-4xl mx-auto p-4"></div>

  <script>
    async function loadData() {
      // ä½¿ç”¨CORSä»£ç†æ¥è§£å†³è·¨åŸŸé—®é¢˜
      const corsProxy = 'https://api.allorigins.win/get?url=';
      const apiUrl = 'https://financialmodelingprep.com/api/v3/historical-price-full/BTCUSD?timeseries=900&apikey=cKlA3lVOMxMjg4hJsC0cn1YAIUu1Hk8P';
      const proxyUrl = corsProxy + encodeURIComponent(apiUrl);
      
      console.log("æ­£åœ¨é€šè¿‡CORSä»£ç†åŠ è½½æ•°æ®:", proxyUrl);
      
      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) {
          console.error(`ä»£ç†è¯·æ±‚å¤±è´¥: ${response.status} - ${response.statusText}`);
          throw new Error(`ä»£ç†è¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        const proxyData = await response.json();
        const data = JSON.parse(proxyData.contents);
        console.log("åŸå§‹APIå“åº”æ•°æ®:", data);

        const historical = data.historical || [];
        console.log("å†å²æ•°æ®æ•°ç»„é•¿åº¦ï¼ˆè¿‡æ»¤å‰ï¼‰:", historical.length);

        const processedData = historical
          .map(item => ({
            date: new Date(item.date),
            price: parseFloat(item.close)
          }))
          .filter(item => item.price != null && !isNaN(item.price))
          .reverse(); // ç¡®ä¿æŒ‰æ—¶é—´æ­£åºæ’åˆ—

        console.log("å¤„ç†åçš„å†å²æ•°æ®é•¿åº¦:", processedData.length);
        if (processedData.length === 0) {
            console.warn("å¤„ç†åçš„å†å²æ•°æ®ä¸ºç©ºï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆçš„ä»·æ ¼æ•°æ®ã€‚");
        }
        return processedData;
      } catch (err) {
        console.error("æ•°æ®åŠ è½½é”™è¯¯:", err);
        console.log("å°è¯•å¤‡ç”¨æ•°æ®æº...");
        return await loadBackupData();
      }
    }

    async function loadBackupData() {
      // å¤‡ç”¨æ•°æ®æºï¼šä½¿ç”¨CoinGecko APIï¼ˆå…è´¹ä¸”æ”¯æŒCORSï¼‰
      console.log("ä½¿ç”¨å¤‡ç”¨æ•°æ®æºï¼šCoinGecko API");
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=90&interval=daily');
        if (!response.ok) {
          throw new Error(`å¤‡ç”¨APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("å¤‡ç”¨APIå“åº”æ•°æ®:", data);
        
        const processedData = data.prices.map(([timestamp, price]) => ({
          date: new Date(timestamp),
          price: parseFloat(price)
        })).filter(item => item.price != null && !isNaN(item.price));
        
        console.log("å¤‡ç”¨æ•°æ®å¤„ç†å®Œæˆï¼Œé•¿åº¦:", processedData.length);
        return processedData;
      } catch (err) {
        console.error("å¤‡ç”¨æ•°æ®æºä¹Ÿå¤±è´¥:", err);
        // å¦‚æœæ‰€æœ‰APIéƒ½å¤±è´¥ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®ç”¨äºæ¼”ç¤º
        return generateMockData();
      }
    }

    function generateMockData() {
      console.log("ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ç”¨äºæ¼”ç¤º");
      const mockData = [];
      const basePrice = 65000;
      const today = new Date();
      
      for (let i = 89; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        
        // ç”Ÿæˆæ¨¡æ‹Ÿä»·æ ¼æ•°æ®ï¼ŒåŒ…å«ä¸€äº›è¶‹åŠ¿å’Œæ³¢åŠ¨
        const trend = Math.sin(i * 0.1) * 5000;
        const noise = (Math.random() - 0.5) * 2000;
        const price = basePrice + trend + noise;
        
        mockData.push({
          date: date,
          price: Math.max(price, 30000) // ç¡®ä¿ä»·æ ¼ä¸ä¼šå¤ªä½
        });
      }
      
      return mockData;
    }

    function calculateIndicators(data) {
      console.log("å¼€å§‹è®¡ç®—æŒ‡æ ‡ï¼Œæ•°æ®é•¿åº¦:", data.length);
      
      const dataWithIndicators = data.map((row, index, arr) => {
        // è®¡ç®—20æ—¥å‡çº¿
        let BTC20MA = null;
        if (index >= 19) {
          const prices = arr.slice(index - 19, index + 1).map(r => r.price);
          if (prices.length === 20 && prices.every(p => typeof p === 'number' && !isNaN(p))) {
            BTC20MA = prices.reduce((sum, p) => sum + p, 0) / 20;
          }
        }

        // è®¡ç®—20æ—¥å‡çº¿è¶‹åŠ¿
        let BTC20MAtrend = 'æœªçŸ¥';
        if (BTC20MA != null && index > 0) {
          const prevBTC20MA = arr[index - 1].BTC20MA;
          if (prevBTC20MA != null) {
            BTC20MAtrend = BTC20MA > prevBTC20MA ? 'ä¸Šå‡' : 'ä¸‹é™';
          }
        }

        return { ...row, BTC20MA, BTC20MAtrend };
      });
      
      console.log("å‰25ä¸ªæ•°æ®ç‚¹ï¼ˆå«MAå’Œè¶‹åŠ¿ï¼‰:", dataWithIndicators.slice(0, 25));
      return dataWithIndicators;
    }

    function generateSignals(data) {
      console.log("å¼€å§‹ç”Ÿæˆäº¤æ˜“ä¿¡å·ï¼Œæ•°æ®é•¿åº¦:", data.length);
      
      const dataWithSignals = data.map((row, index, arr) => {
        // åˆå§‹åŒ–ä¿¡å·å’Œä»“ä½
        let signal = '';
        let currentPosition = 'ç©ºä»“'; // é»˜è®¤åˆå§‹ä»“ä½ä¸ºç©ºä»“
        
        // å¦‚æœä¸æ˜¯ç¬¬ä¸€è¡Œï¼Œä»å‰ä¸€è¡Œç»§æ‰¿ä»“ä½
        if (index > 0) {
          currentPosition = arr[index - 1].POSITION || 'ç©ºä»“';
        }

        // åªæœ‰ä»ç¬¬äºŒè¡Œå¼€å§‹æ‰èƒ½ç”Ÿæˆä¿¡å·ï¼ˆéœ€è¦å‰ä¸€è¡Œçš„æ•°æ®ï¼‰
        if (index > 0) {
          const currentRow = row;
          const prevRow = arr[index - 1];

          // å½“å‰è¡Œæ•°æ®
          const B_current = currentRow.price;       // å½“å‰ä»·æ ¼
          const D_current = currentRow.BTC20MA;     // å½“å‰20æ—¥å‡çº¿
          const F_current = currentRow.BTC20MAtrend; // å½“å‰è¶‹åŠ¿

          // å‰ä¸€è¡Œæ•°æ®
          const B_prev = prevRow.price;             // å‰ä¸€æ—¥ä»·æ ¼
          const D_prev = prevRow.BTC20MA;           // å‰ä¸€æ—¥20æ—¥å‡çº¿
          const F_prev = prevRow.BTC20MAtrend;      // å‰ä¸€æ—¥è¶‹åŠ¿
          const I_prev = prevRow.POSITION;          // å‰ä¸€æ—¥ä»“ä½

          // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„æ•°æ®éƒ½å­˜åœ¨
          if (D_current != null && B_current != null && 
              D_prev != null && B_prev != null && 
              F_current !== 'æœªçŸ¥' && F_prev !== 'æœªçŸ¥') {

            // å–å‡ºä¿¡å·é€»è¾‘
            // IF(AND(D2>B2, F2="ä¸‹é™", OR(AND(B2<D2*(1-0.01), B3>=D3), AND(I3="æŒæœ‰", B2<D2, F3="ä¸Šå‡"))), "å–å‡º", ...)
            if (D_current > B_current && 
                F_current === 'ä¸‹é™' && 
                ((B_current < D_current * (1 - 0.01) && B_prev >= D_prev) ||
                 (I_prev === 'æŒæœ‰' && B_current < D_current && F_prev === 'ä¸Šå‡'))) {
              signal = 'å–å‡º';
            }
            // ä¹°å…¥ä¿¡å·é€»è¾‘  
            // IF(AND(D2<B2, F2="ä¸Šå‡", OR(AND(B2>D2*(1+0.01), B3<=D3), AND(I3="ç©ºä»“", B2>D2, F3="ä¸‹é™"))), "ä¹°å…¥", "")
            else if (D_current < B_current && 
                     F_current === 'ä¸Šå‡' && 
                     ((B_current > D_current * (1 + 0.01) && B_prev <= D_prev) ||
                      (I_prev === 'ç©ºä»“' && B_current > D_current && F_prev === 'ä¸‹é™'))) {
              signal = 'ä¹°å…¥';
            }
          }
        }

        // æ ¹æ®ä¿¡å·æ›´æ–°ä»“ä½
        if (signal === 'ä¹°å…¥') {
          currentPosition = 'æŒæœ‰';
        } else if (signal === 'å–å‡º') {
          currentPosition = 'ç©ºä»“';
        }

        return { ...row, Signal: signal, POSITION: currentPosition };
      });
      
      console.log("æœ€å10ä¸ªæ•°æ®ç‚¹ï¼ˆå«ä¿¡å·ï¼‰:", dataWithSignals.slice(-10));
      return dataWithSignals;
    }

    function formatNumber(num) {
      if (num == null || isNaN(num)) return 'N/A';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    function formatDate(date) {
      return date.toLocaleDateString('zh-CN');
    }

    async function renderDashboard() {
      const root = document.getElementById('root');
      root.innerHTML = '<div class="text-center text-xl text-gray-600 mt-10">ğŸ“Š æ­£åœ¨åŠ è½½æ•°æ®...</div>';
      console.log("å¼€å§‹æ¸²æŸ“ä»ªè¡¨æ¿ã€‚");

      const rawData = await loadData();
      if (rawData.length < 20) {
        root.innerHTML = `
          <div class="text-center text-red-600 mt-10">
            <h2 class="text-2xl font-bold mb-4">âš ï¸ æ•°æ®ä¸è¶³</h2>
            <p>æ— æ³•åŠ è½½è¶³å¤Ÿæ•°æ®è¿›è¡Œåˆ†æã€‚éœ€è¦è‡³å°‘20å¤©çš„æ•°æ®ï¼Œå½“å‰åªæœ‰ ${rawData.length} å¤©ã€‚</p>
            <p class="mt-2">è¯·æ£€æŸ¥APIå¯†é’¥ã€APIæœåŠ¡çŠ¶æ€æˆ–ç¨åå†è¯•ã€‚</p>
          </div>
        `;
        console.error(`æ•°æ®ä¸è¶³è¿›è¡Œåˆ†æ: æ‰¾åˆ°${rawData.length}å¤©æ•°æ®ï¼Œéœ€è¦20å¤©ã€‚`);
        return;
      }

      const dataWithMA = calculateIndicators(rawData);
      const dataWithSignals = generateSignals(dataWithMA);

      // è·å–æœ€æ–°æ•°æ®
      const latest = dataWithSignals[dataWithSignals.length - 1] || {};
      const currentPosition = latest.POSITION || 'æœªçŸ¥';
      const latestPrice = latest.price || 0;
      const latestChange = dataWithSignals.length > 1 && dataWithSignals[dataWithSignals.length - 2].price !== 0
        ? ((latestPrice - dataWithSignals[dataWithSignals.length - 2].price) / dataWithSignals[dataWithSignals.length - 2].price * 100).toFixed(2)
        : 'N/A';
      const latest20MA = latest.BTC20MA;
      const latestTrend = latest.BTC20MAtrend || 'æœªçŸ¥';
      const pricePosition = (latestPrice != null && latest20MA != null && latest20MA !== 0)
        ? (latestPrice > latest20MA ? 'é«˜äº20æ—¥å‡çº¿' : 'ä½äº20æ—¥å‡çº¿')
        : 'æœªçŸ¥';

      // è·å–æœ€è¿‘çš„äº¤æ˜“ä¿¡å·
      const recentSignals = dataWithSignals
        .filter(r => r.Signal && r.Signal !== '')
        .slice(-5)
        .reverse();
      console.log("æ‰¾åˆ°çš„æœ€è¿‘äº¤æ˜“ä¿¡å·:", recentSignals);

      // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
      const totalSignals = dataWithSignals.filter(r => r.Signal && r.Signal !== '').length;
      const buySignals = dataWithSignals.filter(r => r.Signal === 'ä¹°å…¥').length;
      const sellSignals = dataWithSignals.filter(r => r.Signal === 'å–å‡º').length;

      root.innerHTML = `
        <div class="bg-white shadow-xl rounded-lg p-8">
          <h1 class="text-3xl font-bold text-blue-600 mb-6 flex items-center">
            ğŸ“Š BTCäº¤æ˜“ä¿¡å·åˆ†æç³»ç»Ÿ
            <span class="ml-4 text-sm text-gray-500 font-normal">å®æ—¶æ›´æ–°</span>
          </h1>

          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ¯ å½“å‰äº¤æ˜“å»ºè®®</h2>
              <p class="text-2xl font-bold ${currentPosition === 'æŒæœ‰' ? 'text-green-600' : currentPosition === 'ç©ºä»“' ? 'text-red-600' : 'text-gray-500'}">${currentPosition}</p>
            </div>

            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ’° å½“å‰ä»·æ ¼</h2>
              <p class="text-2xl font-bold text-green-600">$${formatNumber(latestPrice)}</p>
              <p class="text-gray-600">24hå˜åŒ–: ${latestChange}%</p>
            </div>

            <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ“ˆ 20æ—¥å‡çº¿</h2>
              <p class="text-xl font-bold text-yellow-600">$${formatNumber(latest20MA)}</p>
              <p class="text-gray-600">è¶‹åŠ¿: ${latestTrend}</p>
              <p class="text-gray-600">ä½ç½®: ${pricePosition}</p>
            </div>

            <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ“Š ä¿¡å·ç»Ÿè®¡</h2>
              <p class="text-sm text-gray-600">æ€»ä¿¡å·: ${totalSignals}</p>
              <p class="text-sm text-green-600">ä¹°å…¥: ${buySignals}</p>
              <p class="text-sm text-red-600">å–å‡º: ${sellSignals}</p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-4">ğŸ” æœ€è¿‘äº¤æ˜“ä¿¡å·</h2>
              <div class="space-y-2">
                ${recentSignals.length > 0 ? recentSignals.map(s => `
                  <div class="flex justify-between items-center border-b py-2">
                    <span class="text-gray-600">${formatDate(s.date)}</span>
                    <span class="px-2 py-1 rounded text-sm font-medium ${s.Signal === 'ä¹°å…¥' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${s.Signal}</span>
                    <span class="font-mono text-sm">$${formatNumber(s.price)}</span>
                  </div>
                `).join('') : '<div class="text-gray-500 text-center py-4">æš‚æ— è¿‘æœŸäº¤æ˜“ä¿¡å·</div>'}
              </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“‹ äº¤æ˜“é€»è¾‘è¯´æ˜</h2>
              <div class="text-sm text-gray-600 space-y-2">
                <p><strong>ä¹°å…¥æ¡ä»¶:</strong></p>
                <ul class="list-disc list-inside ml-2 space-y-1">
                  <li>ä»·æ ¼é«˜äº20æ—¥å‡çº¿ä¸”è¶‹åŠ¿ä¸Šå‡</li>
                  <li>ä»·æ ¼çªç ´å‡çº¿1%ä»¥ä¸Šï¼Œä¸”å‰æ—¥ä½äºå‡çº¿</li>
                  <li>æˆ–ç©ºä»“æ—¶ä»·æ ¼ä¸Šç©¿å‡çº¿ä¸”å‰æ—¥è¶‹åŠ¿ä¸‹é™</li>
                </ul>
                <p><strong>å–å‡ºæ¡ä»¶:</strong></p>
                <ul class="list-disc list-inside ml-2 space-y-1">
                  <li>ä»·æ ¼ä½äº20æ—¥å‡çº¿ä¸”è¶‹åŠ¿ä¸‹é™</li>
                  <li>ä»·æ ¼è·Œç ´å‡çº¿1%ä»¥ä¸Šï¼Œä¸”å‰æ—¥é«˜äºå‡çº¿</li>
                  <li>æˆ–æŒæœ‰æ—¶ä»·æ ¼ä¸‹ç©¿å‡çº¿ä¸”å‰æ—¥è¶‹åŠ¿ä¸Šå‡</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“ˆ ä»·æ ¼èµ°åŠ¿å›¾</h2>
            <div class="bg-white rounded-lg">
              <canvas id="chart" height="100"></canvas>
            </div>
          </div>

          <div class="text-center">
            <p class="text-gray-500 text-xs">
              âš ï¸ æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚æœ€åæ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}
            </p>
          </div>
        </div>
      `;

      // ç»˜åˆ¶å›¾è¡¨
      const ctx = document.getElementById('chart').getContext('2d');
      
      // å‡†å¤‡å›¾è¡¨æ•°æ® - åªæ˜¾ç¤ºæœ€è¿‘60å¤©çš„æ•°æ®ä»¥æé«˜æ€§èƒ½
      const chartData = dataWithSignals.slice(-60);
      const buyPoints = chartData.filter(r => r.Signal === 'ä¹°å…¥');
      const sellPoints = chartData.filter(r => r.Signal === 'å–å‡º');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(r => formatDate(r.date)),
          datasets: [
            {
              label: 'BTCä»·æ ¼',
              data: chartData.map(r => r.price),
              borderColor: '#3B82F6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              tension: 0.1,
              fill: false,
              pointRadius: 1,
              pointHoverRadius: 5
            },
            {
              label: '20æ—¥å‡çº¿',
              data: chartData.map(r => r.BTC20MA),
              borderColor: '#F59E0B',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 2,
              tension: 0.1,
              fill: false,
              pointRadius: 1,
              pointHoverRadius: 5
            },
            {
              label: 'ä¹°å…¥ä¿¡å·',
              data: chartData.map(r => r.Signal === 'ä¹°å…¥' ? r.price : null),
              borderColor: '#10B981',
              backgroundColor: '#10B981',
              pointBackgroundColor: '#10B981',
              pointBorderColor: '#ffffff',
              pointRadius: 6,
              pointHoverRadius: 8,
              showLine: false,
              tension: 0
            },
            {
              label: 'å–å‡ºä¿¡å·',
              data: chartData.map(r => r.Signal === 'å–å‡º' ? r.price : null),
              borderColor: '#EF4444',
              backgroundColor: '#EF4444',
              pointBackgroundColor: '#EF4444',
              pointBorderColor: '#ffffff',
              pointRadius: 6,
              pointHoverRadius: 8,
              showLine: false,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { position: 'top' },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  if (context.dataset.label.includes('ä¿¡å·')) {
                    return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                  }
                  return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¥æœŸ'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'ä»·æ ¼ (USD)'
              },
              ticks: { 
                callback: value => '$' + formatNumber(value)
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
      
      console.log("ä»ªè¡¨æ¿æ¸²æŸ“å®Œæˆã€‚");
    }

    // åˆå§‹åŒ–æ¸²æŸ“
    renderDashboard();
    
    // è®¾ç½®è‡ªåŠ¨åˆ·æ–° - æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    setInterval(renderDashboard, 5 * 60 * 1000);
  </script>

</body>
</html>
