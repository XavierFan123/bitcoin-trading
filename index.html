<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTCäº¤æ˜“ä¿¡å·åˆ†æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div id="root" class="max-w-3xl mx-auto p-4"></div>

  <script>
    async function loadData() {
      const apiUrl = 'https://financialmodelingprep.com/api/v3/historical-price-full/BTCUSD?timeseries=900&apikey=cKlA3lVOMxMjg4hJsC0cn1YAIUu1Hk8P';
      console.log("Attempting to load data from:", apiUrl);
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
          console.error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${response.statusText}`);
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        const data = await response.json();
        console.log("Raw API response data:", data);

        const historical = data.historical || [];
        console.log("Historical data array length (before filtering):", historical.length);

        const processedData = historical.map(item => ({
          date: new Date(item.date),
          price: item.close
        })).filter(item => item.price != null).reverse(); // Ensure price is not null

        console.log("Historical data length (after filtering for null prices and reversing):", processedData.length);
        if (processedData.length === 0) {
            console.warn("Processed historical data is empty. No valid price data found.");
        }
        return processedData;
      } catch (err) {
        console.error("æ•°æ®åŠ è½½é”™è¯¯ (loadData function):", err);
        return [];
      }
    }

    function calculateIndicators(data) {
      console.log("Starting calculateIndicators with data length:", data.length);
      const dataWithIndicators = data.map((row, index, arr) => {
        let BTC20MA = null;
        if (index >= 19) {
          const prices = arr.slice(index - 19, index + 1).map(r => r.price);
          // Check if all 20 prices are valid numbers
          if (prices.length === 20 && prices.every(p => typeof p === 'number' && p != null)) {
            BTC20MA = prices.reduce((sum, p) => sum + p, 0) / 20;
          } else {
            // console.log(`Skipping MA calculation at index ${index} due to invalid prices or insufficient count. Prices:`, prices);
          }
        }
        const prevBTC20MA = index > 0 && arr[index - 1].BTC20MA != null ? arr[index - 1].BTC20MA : null;
        let BTC20MAtrend = 'æœªçŸ¥';
        if (BTC20MA != null && prevBTC20MA != null) {
          BTC20MAtrend = BTC20MA > prevBTC20MA ? 'ä¸Šå‡' : 'ä¸‹é™';
        } else if (BTC20MA != null && index === 0) {
            // This case might not occur often with index >= 19 for MA, but good for robustness
            BTC20MAtrend = 'æ— ';
        }
        return { ...row, BTC20MA, BTC20MAtrend };
      });
      console.log("First 25 data points with MA and trend:", dataWithIndicators.slice(0, 25)); // Log a subset for inspection
      return dataWithIndicators;
    }

    function generateSignals(data) {
        console.log("Starting generateSignals with data length:", data.length);
        const dataWithSignals = data.map((row, index, arr) => {
            let currentPosition = index > 0 ? arr[index - 1].POSITION : 'ç©ºä»“';
            let signal = '';

            if (index === 0) {
                return { ...row, Signal: signal, POSITION: currentPosition };
            }

            const prevRow = arr[index - 1];

            const B2 = row.price;
            const D2 = row.BTC20MA;
            const F2 = row.BTC20MAtrend;
            const B3 = prevRow.price;
            const D3 = prevRow.BTC20MA;
            const F3 = prevRow.BTC20MAtrend;
            const I3 = prevRow.POSITION;

            // Ensure all necessary values are available and meaningful for signal generation
            if (D2 != null && B2 != null && D3 != null && B3 != null && F2 !== 'æœªçŸ¥' && F3 !== 'æœªçŸ¥') {
                // Sell signal logic
                if (
                    D2 > B2 &&
                    F2 === 'ä¸‹é™' &&
                    (
                        (B2 < D2 * 0.99 && B3 >= D3) ||
                        (I3 === 'æŒæœ‰' && B2 < D2 && F3 === 'ä¸Šå‡')
                    )
                ) {
                    signal = 'å–å‡º';
                }
                // Buy signal logic
                else if (
                    D2 < B2 &&
                    F2 === 'ä¸Šå‡' &&
                    (
                        (B2 > D2 * 1.01 && B3 <= D3) ||
                        (I3 === 'ç©ºä»“' && B2 > D2 && F3 === 'ä¸‹é™')
                    )
                ) {
                    signal = 'ä¹°å…¥';
                }
            } else {
                // console.log(`Skipping signal generation at index ${index} due to missing or unknown data. D2:${D2}, B2:${B2}, D3:${D3}, B3:${B3}, F2:${F2}, F3:${F3}`);
            }

            if (signal === 'ä¹°å…¥') {
                currentPosition = 'æŒæœ‰';
            } else if (signal === 'å–å‡º') {
                currentPosition = 'ç©ºä»“';
            }

            return { ...row, Signal: signal, POSITION: currentPosition };
        });
        console.log("Last 10 data points with signals:", dataWithSignals.slice(-10)); // Log the last few for recent signals
        return dataWithSignals;
    }

    function formatNumber(num) {
      if (num == null || isNaN(num)) return 'N/A'; // Handle null, undefined or NaN numbers
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    async function renderDashboard() {
      const root = document.getElementById('root');
      root.innerHTML = '<div class="text-center text-xl text-gray-600 mt-10">ğŸ“Š æ­£åœ¨åŠ è½½æ•°æ®...</div>';
      console.log("Dashboard rendering started.");

      const rawData = await loadData();
      if (rawData.length < 20) {
        root.innerHTML = `
          <div class="text-center text-red-600 mt-10">âš ï¸ æ— æ³•åŠ è½½è¶³å¤Ÿæ•°æ®è¿›è¡Œåˆ†æã€‚éœ€è¦è‡³å°‘20å¤©çš„æ•°æ®ï¼Œå½“å‰åªæœ‰ ${rawData.length} å¤©ã€‚è¯·æ£€æŸ¥APIå¯†é’¥ã€APIæœåŠ¡çŠ¶æ€æˆ–ç¨åå†è¯•ã€‚</div>
        `;
        console.error(`Insufficient data for analysis: ${rawData.length} days found, 20 required.`);
        return;
      }

      const dataWithMA = calculateIndicators(rawData);
      const dataWithSignals = generateSignals(dataWithMA);

      const latest = dataWithSignals[dataWithSignals.length - 1] || {};
      const currentPosition = latest.POSITION || 'æœªçŸ¥';
      const latestPrice = latest.price || 0;
      const latestChange = dataWithSignals.length > 1 && dataWithSignals[dataWithSignals.length - 2].price !== 0
        ? ((latestPrice - dataWithSignals[dataWithSignals.length - 2].price) / dataWithSignals[dataWithSignals.length - 2].price * 100).toFixed(2)
        : 'N/A';
      const latest20MA = latest.BTC20MA; // Keep as null if not calculated
      const latestTrend = latest.BTC20MAtrend || 'æœªçŸ¥';
      const pricePosition = (latestPrice != null && latest20MA != null && latest20MA !== 0)
        ? (latestPrice > latest20MA ? 'é«˜äº20æ—¥å‡çº¿' : 'ä½äº20æ—¥å‡çº¿')
        : 'æœªçŸ¥';

      const recentSignals = dataWithSignals.filter(r => r.Signal).slice(-5).reverse();
      console.log("Recent signals found:", recentSignals);


      root.innerHTML = `
        <div class="bg-white shadow-xl rounded-lg p-8">
          <h1 class="text-3xl font-bold text-blue-600 mb-6 flex items-center">ğŸ“Š BTCäº¤æ˜“ä¿¡å·åˆ†æ</h1>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-50 rounded p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ¯ å½“å‰äº¤æ˜“å»ºè®®</h2>
              <p class="text-2xl font-bold ${currentPosition === 'æŒæœ‰' ? 'text-green-600' : currentPosition === 'ç©ºä»“' ? 'text-red-600' : 'text-gray-500'}">${currentPosition}</p>
            </div>

            <div class="bg-gray-50 rounded p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ’° å½“å‰ä»·æ ¼</h2>
              <p class="text-2xl font-bold text-green-600">$${formatNumber(latestPrice)}</p>
              <p class="text-gray-600">å˜åŒ–: ${latestChange}%</p>
            </div>

            <div class="bg-gray-50 rounded p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ“ˆ 20æ—¥å‡çº¿</h2>
              <p class="text-xl font-bold text-yellow-600">$${formatNumber(latest20MA)}</p>
              <p class="text-gray-600">è¶‹åŠ¿: ${latestTrend}</p>
              <p class="text-gray-600">ä½ç½®: ${pricePosition}</p>
            </div>

            <div class="bg-gray-50 rounded p-4">
              <h2 class="text-lg font-semibold text-gray-700 mb-2">ğŸ” è¿‘æœŸä¿¡å·</h2>
              <ul class="space-y-1">
                ${recentSignals.length > 0 ? recentSignals.map(s => `
                  <li class="flex justify-between border-b py-1">
                    <span>${s.date.toLocaleDateString()}</span>
                    <span class="${s.Signal === 'ä¹°å…¥' ? 'text-green-600' : 'text-red-600'}">${s.Signal}</span>
                    <span>$${formatNumber(s.price)}</span>
                  </li>
                `).join('') : '<li class="text-gray-500">æš‚æ— è¿‘æœŸäº¤æ˜“ä¿¡å·</li>'}
              </ul>
            </div>
          </div>

          <div class="mt-8">
            <canvas id="chart" height="400"></canvas>
          </div>

          <p class="text-gray-500 text-xs mt-6">âš ï¸ æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚</p>
        </div>
      `;

      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dataWithSignals.map(r => r.date.toLocaleDateString()),
          datasets: [
            {
              label: 'BTCä»·æ ¼',
              data: dataWithSignals.map(r => r.price),
              borderColor: '#3B82F6',
              borderWidth: 2,
              tension: 0.1,
              fill: false
            },
            {
              label: '20æ—¥å‡çº¿',
              data: dataWithSignals.map(r => r.BTC20MA),
              borderColor: '#F59E0B',
              borderWidth: 2,
              tension: 0.1,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: {
            y: {
              ticks: { callback: value => '$' + formatNumber(value) }
            }
          }
        }
      });
      console.log("Dashboard rendering complete.");
    }

    renderDashboard();
    setInterval(renderDashboard, 5 * 60 * 1000); // Auto refresh every 5 minutes
  </script>

</body>
</html>
